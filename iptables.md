# iptables

## 目录

<!-- vim-markdown-toc GFM -->

* [防火墙](#防火墙)
    * [TCP Wrapper](#tcp-wrapper)
    * [proxy](#proxy)
    * [iptables](#iptables)
* [nat](#nat)

<!-- vim-markdown-toc -->

## 防火墙
防火墙就是透过订定一些有顺序的规则，并管制进入到我们网域内的主机(或者可以说是网域) 资料封包的一种机制

常见工具：Netfilter、TCP Wrappers、Proxy

常见防护手段：封端口、封源ip、封tcp包中的特殊flag（syn）、封mac

内网防火墙：那就是防火墙除了可以『保护防火墙机制本身所在的那部主机』之外，还可以『保护防火墙后面的主机』。也就是说，防火墙除了可以防备本机被入侵之外， 他还可以架设在路由器上面借以控管进出本地端网域的网路封包。这种规划对于内部私有网域的安全也有一定程度的保护作用

### TCP Wrapper
通过服务名称进行管理，例如ftp的Vstpd，不需要端口号21就可以进行网络管理

通过/etc/hosts.allow，/etc/hosts.deny管理，可以通过软件xinetd和libwrap.so来操作

### proxy
1. 作为正向代理，客户端向proxy发送网络请求，这时就可以在proxy上制定一些规则，如源ip是否合法、目的地址是否合法等，从而达到防火墙的目的

2. 如果proxy规则通过就会代替客户端向目的服务器发送请求

3. 最后proxy将请求对应的响应再传给客户端 

### iptables
参考：https://blog.gmem.cc/iptables

是用户空间命令，基于内核模块Netfilter，根据封包的分析资料"比对" 你预先定义的规则内容，包括mac、ip、tcp、udp、icmp等封包的数据都可以进行过滤分析，所以主要工作在osi七层协议的2，3，4层。 若封包资料与规则内容相同则进行动作，否则就继续下一条规则的比对。

相关软件：  
iptables-services，此软件包含了iptables 服务和 ip6tables 服务，实现开机自动加载规则  
iptables-persistent，ubuntu中实现开机自动加载iptables规则  

iptables是传统的防火墙管理工具，centos7中firewalld和ubuntu中ufw都是新出的linux防火墙工具，不过这些都基于内核中的netfilter，三个防火墙管理工具之间会互相影响，所以一般建议只用其中一种

主要的表有三个：
```
控制进入本机的封包filter(defualt)：INPUT OUTPUT FORWARD
控制路由nat：PREROUTING POSTROUTING OUTPUT
主要与特殊封包的flag相关mangle：PREROUTING OUTPUT INPUT FORWARD
```

iptables-save  将防火墙规则打印到标准输出
```
[root@www ~]# iptables-save
# Generated by iptables-save v1.4.7 on Fri Jul 22 15:51:52 2011
*filter                       <==星号开头的指的是表格，这里为filter 
:INPUT ACCEPT [0:0]           <==冒号开头的指的是链，三条内建的链
:FORWARD ACCEPT [0:0]         <= =三条内建链的政策都是ACCEPT 啰！
:OUTPUT ACCEPT [680:100461]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT  <==针对INPUT 的规则
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT   <==这条很重要！针对本机内部介面开放！
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited  <==针对FORWARD 的规则
COMMIT
# Completed on Fri Jul 22 15:51:52 2011
```

filter表预设都为ACCEPT

service iptables save  保存iptables规则到/etc/sysconfig/iptables文件中，实现开机自动加载规则


示例
```bash
# 设定lo 成为受信任的装置，亦即进出lo 的封包都予以接受
iptables -A INPUT -i lo -j ACCEPT

# 只要是来自内网的(192.168.100.0/24) 的封包通通接受
iptables -A INPUT -i eth1 -s 192.168.100.0/24 -j ACCEPT 

# 记录匹配到该规则的封包写到/var/log/messages中，LOG 这个动作仅在进行记录而已，并不会影响到这个封包的其他规则比对的
iptables -A INPUT -s 192.168.2.200 -j LOG 

# 只要来自 192.168.1.0/24 的1024:65535 埠口的封包，且想要连线到本机的ssh port 就予以抵挡
iptables -A INPUT -i eth0 -p tcp -s 192.168.1.0/24 --sport 1024:65534 --dport ssh -j DROP

# 将来自任何地方来源port 1:1023 的主动连线到本机端的1:1023 连线丢弃
iptables -A INPUT -i eth0 -p tcp --sport 1:1023 --dport 1:1023 --syn -j DROP

# 只要已建立或相关封包就予以通过，只要是不合法封包就丢弃
iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A INPUT -m state --state INVALID -j DROP

# 针对区域网路内的aa:bb:cc:dd:ee:ff 主机开放其连线
iptables -A INPUT -m mac --mac-source aa:bb:cc:dd:ee:ff -j ACCEPT
```

## nat
主要工作在2，3，4层

nat服务器一定是路由器，通常会修改ip包表头，一定有一个public ip和private ip，让lan内的private ip可以透过nat的public ip传出去，而路由器通常两边都是public ip或private ip

snat修改源ip地址，让内网能够连通外网  
dnat修改目的ip地址，让外网主动能够连通内网

示例
```bash
# IP 伪装成为封包出去 (-o) 的那块装置上的IP
iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE 

# snat
iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to-source 192.168.1.100

# dnat
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to-destination 192.168.100.10:80

# 端口转发80-->8080
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080
```
